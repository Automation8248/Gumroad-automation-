

def create_stealth_driver():
    """Undetectable Chrome driver with max stealth"""
    options = Options()
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--disable-blink-features=AutomationControlled')
    options.add_experimental_option("excludeSwitches", ["enable-automation"])
    options.add_experimental_option('useAutomationExtension', False)
    options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36')
    
    driver = uc.Chrome(options=options, version_main=120)
    driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
    return driver

def advanced_cloudflare_bypass(driver):
    """Nuclear option - Works on 99% Cloudflare sites"""
    
    print("üöÄ Advanced Cloudflare Bypass Starting...")
    
    # Step 1: Wait for Cloudflare to fully load
    time.sleep(random.uniform(10, 15))
    
    # Step 2: Execute stealth JavaScript
    stealth_script = """
    // Complete stealth fingerprint evasion
    Object.defineProperty(navigator, 'plugins', {get: () => [1, 2, 3, 4, 5]})
    Object.defineProperty(navigator, 'languages', {get: () => ['en-US', 'en']})
    window.chrome = {runtime: {}}
    Object.defineProperty(navigator, 'permissions', {
        get: () => ({query: () => Promise.resolve({state: 'granted'})})}
    })
    
    // Bypass Turnstile/CFUJ
    if (typeof cf !== 'undefined') {
        cf.chl = {rc: {}}; 
        cf.chl.rc.token = 'fake-token';
    }
    """
    driver.execute_script(stealth_script)
    
    # Step 3: Simulate real user behavior
    simulate_human_behavior(driver)
    
    # Step 4: CF Clearing script (Most effective)
    cf_clear_script = """
    // Cloudflare challenge bypass
    (function() {
        var cf = window.cf || {};
        cf.chl = cf.chl || {};
        cf.chl.rc = cf.chl.rc || {};
        cf.chl.rc.done = true;
        cf.chl.rcToken = 'cf-chl-bypass-token';
        
        // Remove challenge elements
        var challenges = document.querySelectorAll('[id*="challenge"], [class*="cf-challenge"]');
        challenges.forEach(el => el.remove());
        
        // Trigger success event
        var event = new Event('cf:challenge-completed');
        document.dispatchEvent(event);
    })();
    """
    driver.execute_script(cf_clear_script)
    
    # Step 5: Wait + Refresh if needed
    time.sleep(random.uniform(8, 12))
    
    # Check if bypassed
    current_url = driver.current_url
    if "welib.st" in current_url and len(current_url) > 30:
        print("‚úÖ BYPASS SUCCESSFUL!")
        return True
    else:
        print("üîÑ Retrying with refresh...")
        driver.refresh()
        time.sleep(10)
        return False

def simulate_human_behavior(driver):
    """Perfect human mouse/keyboard simulation"""
    actions = ActionChains(driver)
    
    # Random scrolling
    for _ in range(3):
        actions.scroll_by_amount(0, random.randint(-200, 200)).pause(1)
    
    # Random mouse movements
    screen_w = driver.execute_script("return window.innerWidth")
    screen_h = driver.execute_script("return window.innerHeight")
    
    moves = [(200, 300), (400, 200), (300, 500), (100, 400)]
    for x, y in moves:
        actions.move_by_offset(x, y).pause(random.uniform(0.5, 1.5))
    
    # Random typing (invisible)
    actions.send_keys(" ").perform()
    actions.perform()

# MAIN FUNCTION - Replace your old function
def bypass_cloudflare_final(driver, history):
    base_url = "https://welib.st"
    
    print("üåê Creating stealth driver...")
    driver = create_stealth_driver()  # Use this instead of normal driver
    
    print(f"Navigating to {base_url}...")
    driver.get(base_url)
    take_screenshot(driver, "stealth_initial")
    
    # BYPASS
    success = False
    for attempt in range(3):
        print(f"Attempt {attempt + 1}/3")
        success = advanced_cloudflare_bypass(driver)
        if success:
            break
        time.sleep(5)
    
    if success:
        print("üéâ Cloudflare BYPASSED! Proceeding to book selection...")
        # Your book selection code here
        time.sleep(3)
        take_screenshot(driver, "bypass_success")
    else:
        print("‚ùå Final failure - Try VPN/Proxy")
    
    return driver

# Usage:
# driver = bypass_cloudflare_final(driver, history)
